<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Search - AshRedis</title>
    <style>
        .search-result-card {
            transition: transform 0.2s;
        }
        .search-result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .value-preview {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
<th:block th:replace="base :: layout(~{::title}, ~{::main})">
    <main>
        <h1 class="mb-4">üîç Advanced Search</h1>

        <!-- Search Form -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Search Parameters</h5>
            </div>
            <div class="card-body">
                <form th:action="@{/search}" method="post">
                    <div class="row g-3">
                        <!-- Region Selection -->
                        <div class="col-md-4">
                            <label for="region" class="form-label">Region</label>
                            <select class="form-select" id="region" name="region">
                                <option value="all" th:selected="${selectedRegion == null or selectedRegion == 'all'}">
                                    All Regions
                                </option>
                                <option th:each="r : ${regions}"
                                        th:value="${r}"
                                        th:text="${r}"
                                        th:selected="${selectedRegion == r}">
                                    region0
                                </option>
                            </select>
                        </div>

                        <!-- Search Type -->
                        <div class="col-md-4">
                            <label for="searchType" class="form-label">Search Type</label>
                            <select class="form-select" id="searchType" name="searchType">
                                <option value="exact" th:selected="${searchType == null or searchType == 'exact'}">
                                    Exact Match
                                </option>
                                <option value="contains" th:selected="${searchType == 'contains'}">
                                    Contains (Wildcard)
                                </option>
                                <option value="regex" th:selected="${searchType == 'regex'}">
                                    Pattern/Regex
                                </option>
                            </select>
                        </div>

                        <!-- Search Key -->
                        <div class="col-md-4">
                            <label for="searchKey" class="form-label">Search Key</label>
                            <input type="text" class="form-control" id="searchKey"
                                   name="searchKey" th:value="${searchKey}"
                                   placeholder="Enter key or pattern" required>
                        </div>
                    </div>

                    <!-- Help Text -->
                    <div class="mt-3">
                        <div class="alert alert-info mb-0">
                            <strong>Search Tips:</strong>
                            <ul class="mb-0 mt-2">
                                <li><strong>Exact Match:</strong> Finds keys that match exactly (e.g., <code>user:123</code>)</li>
                                <li><strong>Contains:</strong> Finds keys containing the text (automatically adds wildcards)</li>
                                <li><strong>Pattern/Regex:</strong> Use <code>*</code> for wildcard (e.g., <code>user:*</code>, <code>*cache*</code>)</li>
                            </ul>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-search"></i> Search
                        </button>
                        <a th:href="@{/search}" class="btn btn-secondary btn-lg ms-2">Clear</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Search Results -->
        <div th:if="${results != null}">
            <!-- Results Summary -->
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="mb-0">
                        <span class="badge bg-success" th:text="${totalResults + ' results found'}">0 results</span>
                        <span class="text-muted ms-2">in</span>
                        <span class="badge bg-info" th:text="${results.size() + ' region(s)'}">0 regions</span>
                    </h5>
                </div>
            </div>

            <!-- No Results -->
            <div th:if="${totalResults == 0}" class="alert alert-warning">
                <h5 class="alert-heading">No Results Found</h5>
                <p>No keys matching your search criteria were found.</p>
                <hr>
                <p class="mb-0">
                    <strong>Suggestions:</strong>
                <ul>
                    <li>Try a different search pattern</li>
                    <li>Select a different region or "All Regions"</li>
                    <li>Use "Contains" search type for broader results</li>
                </ul>
                </p>
            </div>

            <!-- Results by Region -->
            <div th:if="${totalResults > 0}">
                <div th:each="regionEntry : ${results}" class="mb-4">
                    <h4 class="mb-3">
                        Region: <span class="text-primary" th:text="${regionEntry.key}">region0</span>
                        <span class="badge bg-secondary" th:text="${regionEntry.value.size() + ' keys'}">0 keys</span>
                    </h4>

                    <div class="row">
                        <div th:each="result : ${regionEntry.value}" class="col-md-6 mb-3">
                            <div class="card search-result-card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <code th:text="${result.key}">key</code>
                                    </h6>

                                    <div class="mb-2">
                                        <small class="text-muted">
                                            <strong>Region:</strong> <span th:text="${result.region}">region0</span> |
                                            <strong>TTL:</strong>
                                            <span th:if="${result.ttl == -1}">No expiration</span>
                                            <span th:if="${result.ttl == -2}" class="text-danger">Expired/Not found</span>
                                            <span th:if="${result.ttl > 0}" th:text="${result.ttl + 's'}">60s</span>
                                        </small>
                                    </div>

                                    <div class="value-preview mb-3">
                                        <small th:text="${result.valuePreview}">value preview</small>
                                    </div>

                                    <div class="d-grid">
                                        <a th:href="@{/entry/{region}/{key}(region=${result.region},key=${result.key})}"
                                           class="btn btn-sm btn-outline-primary">
                                            View Details ‚Üí
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Getting Started (when no search performed) -->
        <div th:if="${results == null}" class="alert alert-light border">
            <h5 class="alert-heading">üí° Getting Started with Search</h5>
            <p>Use the search form above to find keys across your cache.</p>
            <hr>
            <div class="row">
                <div class="col-md-4">
                    <h6>üéØ Exact Match</h6>
                    <p class="small">Find a specific key by its exact name.</p>
                    <code class="small">user:123</code>
                </div>
                <div class="col-md-4">
                    <h6>üî§ Contains Search</h6>
                    <p class="small">Find all keys containing specific text.</p>
                    <code class="small">session</code> ‚Üí finds all keys with "session"
                </div>
                <div class="col-md-4">
                    <h6>üé® Pattern Match</h6>
                    <p class="small">Use wildcards for flexible matching.</p>
                    <code class="small">user:*</code> ‚Üí finds user:1, user:2, etc.
                </div>
            </div>
        </div>
    </main>
</th:block>
</body>
</html>